<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMMD - Console Chef de Maison</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc;
        }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .tab-active { 
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%) !important; 
            color: white !important;
            box-shadow: 0 10px 15px -3px rgba(30, 58, 138, 0.2);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        @keyframes pulse-orange {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); transform: scale(1); }
            70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); transform: scale(1); }
        }

        .blink-alert {
            animation: pulse-orange 2s infinite ease-in-out;
            background-color: #f59e0b;
        }

        .glass-nav {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%);
        }

        input:focus, select:focus {
            ring: 2px solid #3b82f6 !important;
            background-color: white !important;
        }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.01);
        }
    </style>
</head>
<body class="text-slate-900 pb-20">

    <nav class="glass-nav text-white p-6 rounded-b-[45px] shadow-2xl sticky top-0 z-50 border-b border-white/10">
        <div class="flex justify-between items-start mb-8">
            <div>
                <h1 id="user-name" class="text-2xl font-black italic tracking-tighter bg-gradient-to-r from-white to-blue-300 bg-clip-text text-transparent">Chef de Maison</h1>
                <p id="maison-name" class="text-[10px] uppercase tracking-[0.3em] text-blue-400/80 font-bold italic">Chargement...</p>
            </div>
            <div class="flex gap-2">
                <button onclick="openSettingsModal()" class="bg-white/10 hover:bg-white/20 p-2.5 rounded-2xl transition-all">‚öôÔ∏è</button>
                <button onclick="exportMaisonExcel()" class="bg-emerald-500/20 text-emerald-400 p-2.5 rounded-2xl border border-emerald-500/20 font-black text-[10px] uppercase">Bilan</button>
                <button onclick="logout()" class="bg-red-500/10 text-red-400 p-2.5 rounded-2xl border border-red-500/20 font-black text-[10px] uppercase">Sortir</button>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="bg-white/5 backdrop-blur-md p-5 rounded-[30px] border border-white/10">
                <p class="text-[8px] font-black uppercase tracking-widest mb-2 opacity-60">Mon Solde Perso</p>
                <p id="solde-perso" class="text-2xl font-black tracking-tight">-- ‚Ç¨</p>
            </div>
            <div class="bg-emerald-500/10 backdrop-blur-md p-5 rounded-[30px] border border-emerald-500/20">
                <p class="text-[8px] font-black uppercase tracking-widest mb-2 text-emerald-400">Tr√©sorerie Maison</p>
                <p id="solde-maison" class="text-2xl font-black tracking-tight text-emerald-50">-- ‚Ç¨</p>
            </div>
        </div>

        <div class="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
            <a href="#section-perso" class="bg-white/10 px-5 py-2.5 rounded-full text-[9px] font-black uppercase tracking-widest whitespace-nowrap border border-white/5">D√©penses</a>
            <a href="#section-validation" class="bg-white/10 px-5 py-2.5 rounded-full text-[9px] font-black uppercase tracking-widest whitespace-nowrap border border-white/5 flex items-center gap-2">
                Remboursements <span id="alert-dot" class="hidden h-2.5 w-2.5 rounded-full blink-alert"></span>
            </a>
            <a href="#section-membres" class="bg-white/10 px-5 py-2.5 rounded-full text-[9px] font-black uppercase tracking-widest whitespace-nowrap border border-white/5">Membres</a>
            <a href="#section-audit" class="bg-white/10 px-5 py-2.5 rounded-full text-[9px] font-black uppercase tracking-widest whitespace-nowrap border border-white/5">Audit</a>
        </div>
    </nav>

    <main class="p-6 space-y-10">

        <section id="section-perso" class="space-y-4">
            <div class="flex items-center gap-2 px-2">
                <div class="h-1 w-4 bg-blue-600 rounded-full"></div>
                <h2 class="text-[11px] font-black uppercase text-slate-400 tracking-[0.2em]">Ma Gestion Perso</h2>
            </div>
            <div class="bg-white p-7 rounded-[40px] shadow-sm border border-slate-100">
                <div class="flex gap-3 mb-8 bg-slate-100 p-1.5 rounded-[22px]">
                    <button onclick="setTxType('depense')" id="tab-depense" class="flex-1 py-3 rounded-[18px] font-black text-[10px] uppercase transition-all tab-active">D√©pense</button>
                    <button onclick="setTxType('recette')" id="tab-recette" class="flex-1 py-3 rounded-[18px] font-black text-[10px] uppercase transition-all text-slate-400">Recette</button>
                </div>
                <div class="space-y-5">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 ml-4 mb-1 block tracking-widest">Date de l'op√©ration</label>
                        <input type="date" id="tx-date" class="w-full p-4 bg-slate-50 rounded-2xl border-transparent font-bold text-sm outline-none focus:ring-2 focus:ring-blue-500/20">
                    </div>
                    <div>
                         <label class="text-[9px] font-black uppercase text-slate-400 ml-4 mb-1 block tracking-widest">Montant</label>
                         <input type="number" id="tx-amount" step="0.01" placeholder="0.00 ‚Ç¨" class="w-full p-5 bg-slate-50 rounded-2xl border-transparent font-black text-2xl outline-none focus:ring-2 focus:ring-blue-500/20">
                    </div>
                    <div id="container-motif">
                        <label class="text-[9px] font-black uppercase text-slate-400 ml-4 mb-1 block tracking-widest">Motif</label>
                        <select id="tx-motif" class="w-full p-4 bg-slate-50 rounded-2xl border-transparent font-bold outline-none text-sm focus:ring-2 focus:ring-blue-500/20"></select>
                    </div>
                    <div id="container-paiement">
                        <label class="text-[9px] font-black uppercase text-slate-400 ml-4 mb-1 block tracking-widest">Moyen de paiement</label>
                        <select id="tx-method" class="w-full p-4 bg-slate-50 rounded-2xl border-transparent font-bold outline-none text-sm focus:ring-2 focus:ring-blue-500/20">
                            <option value="cb_maison">üí≥ CB MAISON</option>
                            <option value="perso_cb">üì± PERSO - CB</option>
                            <option value="perso_liq">üíµ PERSO - Liquide</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 ml-4 mb-1 block tracking-widest">Commentaire</label>
                        <input type="text" id="tx-note" placeholder="Note rapide..." class="w-full p-4 bg-slate-50 rounded-2xl border-transparent font-bold outline-none text-sm focus:ring-2 focus:ring-blue-500/20">
                    </div>
                    <button onclick="submitTransaction()" class="w-full bg-slate-900 text-white font-black py-5 rounded-[22px] uppercase tracking-[0.2em] shadow-xl shadow-blue-900/10 active:scale-[0.98] transition-all mt-4">Enregistrer</button>
                </div>
            </div>
        </section>

        <section id="section-validation" class="bg-orange-50 p-7 rounded-[40px] border border-orange-100 shadow-inner">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-2">
                    <div class="h-1 w-4 bg-orange-500 rounded-full"></div>
                    <h2 class="text-[11px] font-black uppercase text-orange-700 tracking-[0.2em]">Dettes Membres</h2>
                </div>
                <div id="total-dettes" class="bg-orange-500 text-white px-4 py-1.5 rounded-full text-[10px] font-black shadow-lg shadow-orange-500/20">Total : 0‚Ç¨</div>
            </div>
            <div id="list-avances-attente" class="space-y-4"></div>
        </section>

        <section id="section-membres" class="space-y-4">
            <div class="flex items-center gap-2 px-2">
                <div class="h-1 w-4 bg-indigo-500 rounded-full"></div>
                <h2 class="text-[11px] font-black uppercase text-slate-400 tracking-[0.2em]">Annuaire & IBAN</h2>
            </div>
            <div id="list-membres" class="space-y-3"></div>
        </section>

        <section id="section-audit" class="space-y-4">
            <div class="flex items-center gap-2 px-2">
                <div class="h-1 w-4 bg-emerald-500 rounded-full"></div>
                <h2 class="text-[11px] font-black uppercase text-slate-400 tracking-[0.2em]">Journal Maison</h2>
            </div>
            <div id="audit-history" class="bg-white rounded-[40px] border border-slate-100 overflow-hidden card-shadow"></div>
        </section>

    </main>

    <div id="settings-modal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-6 z-[100]">
        <div class="bg-white p-8 rounded-[45px] w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar border border-white/20">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-2xl font-black italic tracking-tighter text-slate-800">Profil</h3>
                <button onclick="closeSettingsModal()" class="text-slate-300 text-2xl">‚úï</button>
            </div>
            <div class="space-y-8">
                <div class="bg-slate-50 p-5 rounded-3xl">
                    <label class="text-[9px] font-black uppercase text-slate-400 ml-2 tracking-widest block mb-2">Allocation Mensuelle (‚Ç¨)</label>
                    <input type="number" id="settings-allocation" class="w-full bg-white p-4 rounded-2xl border-none font-black text-lg shadow-sm focus:ring-2 focus:ring-blue-500/10">
                    <button onclick="updateAllocation()" class="w-full mt-3 bg-white text-slate-600 text-[9px] font-black py-3 rounded-xl uppercase border border-slate-200 hover:bg-slate-50">Mettre √† jour</button>
                </div>
                
                <div class="bg-slate-50 p-5 rounded-3xl">
                    <label class="text-[9px] font-black uppercase text-slate-400 ml-2 tracking-widest block mb-2">Mon IBAN</label>
                    <input type="text" id="settings-iban" class="w-full bg-white p-4 rounded-2xl border-none font-mono text-xs shadow-sm focus:ring-2 focus:ring-blue-500/10 uppercase">
                    <button onclick="updateIban()" class="w-full mt-3 bg-white text-slate-600 text-[9px] font-black py-3 rounded-xl uppercase border border-slate-200 hover:bg-slate-50">Mettre √† jour l'IBAN</button>
                </div>

                <div class="pt-4">
                    <label class="text-[9px] font-black uppercase text-slate-400 ml-2 tracking-widest block mb-2 text-center">S√©curit√©</label>
                    <input type="password" id="settings-pass" placeholder="Nouveau mot de passe" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-bold outline-none text-center mb-3">
                    <button onclick="updatePassword()" class="w-full bg-slate-900 text-white text-[10px] font-black py-4 rounded-2xl uppercase tracking-widest shadow-lg active:scale-95">Changer le mot de passe</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://xccnnckuphxloxfrqtkf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjY25uY2t1cGh4bG94ZnJxdGtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODA3NjEsImV4cCI6MjA4Mjc1Njc2MX0.1mIEhKfS5OSsaw78f1_Iatni39y8CoIurAd5IXP6n6g";
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let userProfile = null;
        let currentType = 'depense';

        async function checkAuth() {
            const { data: { user } } = await sb.auth.getUser();
            if (!user) { window.location.href = "index.html"; return; }
            const { data: profile } = await sb.from('profiles').select('*, maisons(*)').eq('id', user.id).single();
            if (!profile || profile.role !== 'chef') { window.location.href = "user.html"; return; }
            userProfile = profile;
            document.getElementById('user-name').innerText = `${profile.prenom} ${profile.nom}`;
            document.getElementById('maison-name').innerText = `Maison ${profile.maisons.nom}`;
            document.getElementById('tx-date').valueAsDate = new Date();
            loadMotifs();
            refreshAll();
        }

        async function refreshAll() {
            refreshSoldes();
            loadAvancesChef();
            loadMembres();
            loadAuditGlobal();
        }

        async function refreshSoldes() {
            const { data: soldes } = await sb.from('soldes_calculables').select('*').eq('maison_id', userProfile.maison_id);
            let totalMaison = 0; let monPerso = 0;
            if(soldes) {
                soldes.forEach(s => {
                    const solde = parseFloat(s.total_allocations) + parseFloat(s.total_transactions);
                    totalMaison += solde;
                    if(s.user_id === userProfile.id) monPerso = solde;
                });
            }
            document.getElementById('solde-maison').innerText = totalMaison.toFixed(2) + " ‚Ç¨";
            document.getElementById('solde-perso').innerText = monPerso.toFixed(2) + " ‚Ç¨";
        }

        async function loadAvancesChef() {
            const { data } = await sb.from('transactions').select('*, profiles(*)').eq('maison_id', userProfile.maison_id).eq('statut', 'attente');
            let dettesSum = 0; const groups = {};
            if(data && data.length > 0) {
                document.getElementById('alert-dot').classList.remove('hidden');
                data.forEach(t => {
                    dettesSum += t.montant;
                    if(!groups[t.user_id]) groups[t.user_id] = { name: `${t.profiles.prenom} ${t.profiles.nom}`, iban: t.profiles.iban, total:0, txs: [] };
                    groups[t.user_id].txs.push(t);
                    groups[t.user_id].total += t.montant;
                });
            } else {
                document.getElementById('alert-dot').classList.add('hidden');
            }
            document.getElementById('total-dettes').innerText = `Total : ${dettesSum.toFixed(2)}‚Ç¨`;
            document.getElementById('list-avances-attente').innerHTML = Object.keys(groups).map(uid => `
                <div class="bg-white p-5 rounded-[30px] border border-orange-200 shadow-sm">
                    <div class="flex justify-between items-center mb-3">
                        <p class="font-black text-[11px] text-orange-600 uppercase tracking-widest">${groups[uid].name}</p>
                        <p class="font-black text-sm text-slate-800">${groups[uid].total.toFixed(2)}‚Ç¨</p>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-2xl flex items-center justify-between gap-3 mb-4">
                        <p class="text-[9px] font-mono text-slate-400 truncate flex-1">${groups[uid].iban || 'IBAN MANQUANT'}</p>
                        <button onclick="copyIban('${groups[uid].iban}')" class="text-[9px] font-black text-blue-600 uppercase">Copier</button>
                    </div>
                    <button onclick="validerTout('${uid}', ${groups[uid].total})" class="w-full bg-orange-600 text-white py-3 rounded-2xl text-[10px] font-black uppercase shadow-lg shadow-orange-600/20 active:scale-95 transition-all mb-4">Valider le virement</button>
                    <div class="space-y-2 border-t border-slate-50 pt-3">
                        ${groups[uid].txs.map(t => `<div class="flex justify-between text-[9px] text-slate-500 font-medium"><span>${t.motif}</span><span class="font-bold text-slate-700">${t.montant.toFixed(2)}‚Ç¨</span></div>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        async function validerTout(uid, montantTotal) {
            if(!confirm("Confirmer le remboursement global pour ce membre ?")) return;
            const { error: errorTx } = await sb.from('transactions').update({ statut: 'valide', date_validation: new Date().toISOString() }).eq('user_id', uid).eq('statut', 'attente');
            if(!errorTx) {
                await sb.from('notifications').insert([{ user_id: uid, message: `Votre chef de maison a effectu√© un virement de ${montantTotal.toFixed(2)}‚Ç¨ pour vos avances de frais.` }]);
                alert("Remboursement valid√© et membre notifi√© !");
                refreshAll();
            } else { alert("Erreur lors de la validation."); }
        }

        async function exportMaisonExcel() {
            const moisInput = prompt("Mois (MM) :");
            const anneeInput = prompt("Ann√©e (YYYY) :", new Date().getFullYear());
            if(!moisInput || !anneeInput) return;
            const { data: txData } = await sb.from('transactions').select('*, profiles(prenom, nom)').eq('maison_id', userProfile.maison_id);
            const { data: membersData } = await sb.from('profiles').select('prenom, nom, allocation_mensuelle').eq('maison_id', userProfile.maison_id);
            const filteredTx = txData.filter(t => t.created_at.includes(`${anneeInput}-${moisInput.padStart(2, '0')}-`));
            let finalRows = []; let totalRecettes = 0; let totalDepenses = 0; let syntheseMotifs = {};
            membersData.forEach(m => {
                if(m.allocation_mensuelle > 0) {
                    finalRows.push({ "Date": `01/${moisInput}/${anneeInput}`, "Membre": `${m.prenom} ${m.nom}`, "Type": "RECETTE", "Motif": "ALLOCATION MENSUELLE", "Montant (‚Ç¨)": m.allocation_mensuelle, "M√©thode": "VERSEMENT", "Note": "Pr√©vu" });
                    totalRecettes += m.allocation_mensuelle;
                }
            });
            filteredTx.forEach(t => {
                const mt = t.montant;
                finalRows.push({ "Date": new Date(t.created_at).toLocaleDateString(), "Membre": t.profiles.prenom, "Type": t.type.toUpperCase(), "Motif": t.motif || "RECETTE", "Montant (‚Ç¨)": mt, "M√©thode": t.methode_paiement || "N/A", "Note": t.commentaire || "" });
                if(t.type === 'recette') { totalRecettes += mt; } else { totalDepenses += mt; syntheseMotifs[t.motif] = (syntheseMotifs[t.motif] || 0) + mt; }
            });
            const ws = XLSX.utils.json_to_sheet(finalRows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Journal");
            let resumeRows = [ { "Cat√©gorie": "TOTAL RECETTES (Allocations incluses)", "Valeur (‚Ç¨)": totalRecettes }, { "Cat√©gorie": "TOTAL D√âPENSES", "Valeur (‚Ç¨)": totalDepenses }, { "Cat√©gorie": "SOLDE DU MOIS", "Valeur (‚Ç¨)": totalRecettes - totalDepenses }, {}, { "Cat√©gorie": "D√âTAIL PAR MOTIF", "Valeur (‚Ç¨)": "" } ];
            Object.keys(syntheseMotifs).forEach(m => resumeRows.push({ "Cat√©gorie": m, "Valeur (‚Ç¨)": syntheseMotifs[m] }));
            const ws2 = XLSX.utils.json_to_sheet(resumeRows); XLSX.utils.book_append_sheet(wb, ws2, "Bilan");
            XLSX.writeFile(wb, `SMMD_${userProfile.maisons.nom}_${moisInput}_${anneeInput}.xlsx`);
            if(confirm("Voulez-vous notifier la maison par email ?")) {
                const subject = encodeURIComponent(`Bilan SMMD - ${userProfile.maisons.nom} - ${moisInput}/${anneeInput}`);
                const body = encodeURIComponent(`Bonjour,\n\nLe bilan du mois a √©t√© g√©n√©r√©.\nRecettes : ${totalRecettes}‚Ç¨\nD√©penses : ${totalDepenses}‚Ç¨\nSolde : ${totalRecettes - totalDepenses}‚Ç¨\n\nConsultez le fichier Excel pour le d√©tail.`);
                window.location.href = `mailto:?subject=${subject}&body=${body}`;
            }
        }

        async function loadAuditGlobal() {
            const { data } = await sb.from('transactions').select('*, profiles(prenom)').eq('maison_id', userProfile.maison_id).order('created_at', { ascending: false }).limit(40);
            document.getElementById('audit-history').innerHTML = data.map(t => `
                <div class="p-5 border-b border-slate-50 flex justify-between items-center transition-colors hover:bg-slate-50/50">
                    <div class="flex items-center gap-4">
                        <button onclick="supprimerOperation('${t.id}')" class="bg-red-50 text-red-300 hover:text-red-500 w-8 h-8 rounded-full flex items-center justify-center transition-all">‚úï</button>
                        <div>
                            <p class="font-black uppercase text-[9px] text-slate-400 tracking-widest">${t.profiles.prenom} ‚Ä¢ ${t.motif || 'RECETTE'}</p>
                            <p class="text-[8px] text-slate-300 font-bold mb-1">${new Date(t.created_at).toLocaleDateString('fr-FR')}</p>
                            <p class="font-bold text-slate-700 text-[11px]">${t.commentaire || 'Sans commentaire'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-black text-sm ${t.type === 'recette' ? 'text-emerald-500' : 'text-slate-900'}">${t.type === 'recette' ? '+' : '-'}${t.montant.toFixed(2)}‚Ç¨</p>
                        <p class="text-[8px] uppercase font-black px-2 py-0.5 rounded-full mt-1 inline-block ${t.statut === 'attente' ? 'bg-orange-50 text-orange-500' : 'bg-emerald-50 text-emerald-500'}">
                            ${t.statut === 'attente' ? 'En attente' : 'Valid√©'}
                        </p>
                    </div>
                </div>
            `).join('');
        }

        async function submitTransaction() {
            const amount = parseFloat(document.getElementById('tx-amount').value);
            const date = document.getElementById('tx-date').value;
            const note = document.getElementById('tx-note').value.trim();
            const motif = document.getElementById('tx-motif').value;
            const method = document.getElementById('tx-method').value;
            if(!amount || !date) return alert("Montant et date requis");
            const { error } = await sb.from('transactions').insert([{ 
                user_id: userProfile.id, maison_id: userProfile.maison_id, montant: amount, 
                motif: currentType === 'recette' ? 'RECETTE' : motif, commentaire: note, 
                created_at: new Date(date).toISOString(), type: currentType, 
                methode_paiement: currentType === 'recette' ? null : method, 
                statut: (currentType === 'depense' && method.startsWith('perso_')) ? 'attente' : 'valide' 
            }]);
            if(!error) { document.getElementById('tx-amount').value = ''; document.getElementById('tx-note').value = ''; refreshAll(); }
        }

        async function loadMotifs() {
            const { data } = await sb.from('motifs').select('nom').order('nom');
            document.getElementById('tx-motif').innerHTML = data.map(m => `<option value="${m.nom}">${m.nom.toUpperCase()}</option>`).join('');
        }

        async function loadMembres() {
            const { data } = await sb.from('profiles').select('*').eq('maison_id', userProfile.maison_id);
            document.getElementById('list-membres').innerHTML = data.map(m => `
                <div class="bg-white p-5 rounded-[30px] flex justify-between items-center card-shadow border border-slate-50">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                             <p class="font-black text-xs uppercase text-slate-800">${m.prenom} ${m.nom}</p>
                             ${m.role === 'chef' ? '<span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-black">CHEF</span>' : ''}
                        </div>
                        <p class="text-[9px] text-slate-400 font-bold uppercase mb-3">Allocation : ${m.allocation_mensuelle || 0}‚Ç¨ / mois</p>
                        <div class="bg-slate-50 p-3 rounded-2xl flex items-center justify-between gap-3">
                             <p class="text-[9px] font-mono text-slate-500 truncate uppercase">${m.iban || 'IBAN NON RENSEIGN√â'}</p>
                             ${m.iban ? `<button onclick="copyIban('${m.iban}')" class="text-[9px] font-black text-blue-600 uppercase">Copier</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function setTxType(type) { 
            currentType = type; const isR = type === 'recette'; 
            document.getElementById('container-motif').classList.toggle('hidden', isR); 
            document.getElementById('container-paiement').classList.toggle('hidden', isR); 
            document.getElementById('tab-depense').className = isR ? "flex-1 py-3 rounded-[18px] font-black text-[10px] text-slate-400 bg-slate-100" : "flex-1 py-3 rounded-[18px] font-black text-[10px] bg-slate-900 text-white tab-active"; 
            document.getElementById('tab-recette').className = isR ? "flex-1 py-3 rounded-[18px] font-black text-[10px] bg-emerald-500 text-white shadow-lg shadow-emerald-500/20" : "flex-1 py-3 rounded-[18px] font-black text-[10px] text-slate-400 bg-slate-100"; 
        }

        function openSettingsModal() { 
            document.getElementById('settings-modal').classList.remove('hidden'); 
            document.getElementById('settings-iban').value = userProfile.iban || ''; 
            document.getElementById('settings-allocation').value = userProfile.allocation_mensuelle || 0;
        }
        function closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }
        async function updateAllocation() {
            const newVal = parseFloat(document.getElementById('settings-allocation').value);
            await sb.from('profiles').update({ allocation_mensuelle: newVal }).eq('id', userProfile.id);
            alert("Allocation mise √† jour !"); refreshAll();
        }
        async function updateIban() {
            const newIban = document.getElementById('settings-iban').value.trim();
            await sb.from('profiles').update({ iban: newIban }).eq('id', userProfile.id);
            userProfile.iban = newIban; alert("IBAN mis √† jour !"); refreshAll();
        }
        async function updatePassword() {
            const newPass = document.getElementById('settings-pass').value;
            if(newPass.length < 6) return alert("6 car. min");
            await sb.auth.updateUser({ password: newPass });
            alert("Mot de passe modifi√© !"); closeSettingsModal();
        }
        async function supprimerOperation(id) {
            if(!confirm("Supprimer cette op√©ration ?")) return;
            await sb.from('transactions').delete().eq('id', id);
            refreshAll();
        }
        function copyIban(iban) { if(!iban) return; navigator.clipboard.writeText(iban); alert("IBAN copi√© !"); }
        function logout() { sb.auth.signOut().then(() => location.href="index.html"); }
        checkAuth();
    </script>
</body>
</html>
