<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMMD - Console Chef de Maison</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .tab-active { background-color: #1e3a8a !important; color: white !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-20">

    <nav class="bg-blue-900 text-white p-6 rounded-b-[40px] shadow-lg sticky top-0 z-50">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h1 id="user-name" class="text-xl font-black italic tracking-tighter">Chef de Maison</h1>
                <p id="maison-name" class="text-[10px] uppercase tracking-[0.2em] opacity-60 font-bold italic">Chargement...</p>
            </div>
            <div class="flex gap-2">
                <button onclick="openSettingsModal()" class="bg-blue-500/20 text-blue-100 px-3 py-1.5 rounded-xl text-[9px] font-black uppercase">‚öôÔ∏è Profil</button>
                <button onclick="exportMaisonExcel()" class="bg-emerald-500/20 text-emerald-100 px-3 py-1.5 rounded-xl text-[9px] font-black uppercase">üìä Export</button>
                <button onclick="logout()" class="bg-red-500/20 text-red-100 px-3 py-1.5 rounded-xl text-[9px] font-black uppercase">Sortir</button>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="bg-blue-800/40 p-4 rounded-2xl border border-blue-700/30">
                <p class="text-[7px] font-black uppercase tracking-widest mb-1 opacity-50">Mon Solde Perso</p>
                <p id="solde-perso" class="text-xl font-black">-- ‚Ç¨</p>
            </div>
            <div class="bg-emerald-500/20 p-4 rounded-2xl border border-emerald-500/20">
                <p class="text-[7px] font-black uppercase tracking-widest mb-1 opacity-50">Tr√©sorerie Maison</p>
                <p id="solde-maison" class="text-xl font-black">-- ‚Ç¨</p>
            </div>
        </div>

        <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
            <a href="#section-perso" class="bg-white/10 px-4 py-2 rounded-lg text-[9px] font-black uppercase whitespace-nowrap">Mes D√©penses</a>
            <a href="#section-membres" class="bg-white/10 px-4 py-2 rounded-lg text-[9px] font-black uppercase whitespace-nowrap">Membres & IBAN</a>
            <a href="#section-audit" class="bg-white/10 px-4 py-2 rounded-lg text-[9px] font-black uppercase whitespace-nowrap">Audit Global</a>
        </div>
    </nav>

    <main class="p-6 space-y-8">

        <section id="section-perso" class="space-y-4">
            <h2 class="text-[10px] font-black uppercase text-gray-400 tracking-widest px-2">Ma Gestion Personnelle</h2>
            
            <div class="bg-white p-6 rounded-[35px] shadow-sm border border-gray-100">
                <div class="flex gap-4 mb-6">
                    <button onclick="setTxType('depense')" id="tab-depense" class="flex-1 py-3 rounded-xl font-black text-[10px] uppercase bg-blue-900 text-white tab-active">D√©pense</button>
                    <button onclick="setTxType('recette')" id="tab-recette" class="flex-1 py-3 rounded-xl font-black text-[10px] uppercase bg-gray-100 text-gray-400">Recette</button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-black uppercase text-gray-400 ml-2">Date de l'op√©ration</label>
                        <input type="date" id="tx-date" class="w-full p-4 bg-gray-50 rounded-2xl border-none font-bold text-sm outline-none mt-1">
                    </div>

                    <input type="number" id="tx-amount" step="0.01" placeholder="Montant (‚Ç¨)" class="w-full p-4 bg-gray-50 rounded-2xl border-none font-black text-xl outline-none focus:ring-2 focus:ring-blue-500">
                    
                    <div id="container-motif">
                        <label class="text-[10px] font-black uppercase text-gray-400 ml-2">Motif</label>
                        <select id="tx-motif" class="w-full p-4 bg-gray-50 rounded-2xl border-none font-bold outline-none text-sm mt-1"></select>
                    </div>

                    <div id="container-paiement">
                        <label class="text-[10px] font-black uppercase text-gray-400 ml-2">Moyen de paiement</label>
                        <select id="tx-method" class="w-full p-4 bg-gray-50 rounded-2xl border-none font-bold outline-none text-sm mt-1">
                            <option value="cb_maison">CB MAISON</option>
                            <option value="perso_cb">PERSO - CB</option>
                            <option value="perso_liq">PERSO - Liquide</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-[10px] font-black uppercase text-gray-400 ml-2">Commentaire</label>
                        <input type="text" id="tx-note" placeholder="Optionnel..." class="w-full p-4 bg-gray-50 rounded-2xl border-none font-bold outline-none text-sm mt-1">
                    </div>

                    <button onclick="submitTransaction()" class="w-full bg-blue-900 text-white font-black py-5 rounded-2xl uppercase tracking-widest shadow-lg active:scale-95 transition-all">Enregistrer</button>
                </div>
            </div>
        </section>

        <section id="section-validation" class="bg-orange-50 p-6 rounded-[35px] border border-orange-100">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-[10px] font-black uppercase text-orange-600 tracking-widest">Avances en attente</h2>
                <div id="total-dettes" class="bg-orange-600 text-white px-3 py-1 rounded-full text-[10px] font-black">Total : 0‚Ç¨</div>
            </div>
            <div id="list-avances-attente" class="space-y-4"></div>
        </section>

        <section id="section-membres" class="space-y-4">
            <h2 class="text-[10px] font-black uppercase text-gray-400 tracking-widest px-2">Annuaire & IBAN</h2>
            <div id="list-membres" class="space-y-3"></div>
        </section>

        <section id="section-audit" class="space-y-4">
            <h2 class="text-[10px] font-black uppercase text-gray-400 tracking-widest px-2">Journal de Bord Maison</h2>
            <div id="audit-history" class="bg-white rounded-[35px] overflow-hidden border border-gray-100"></div>
        </section>

    </main>

    <div id="settings-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
        <div class="bg-white p-8 rounded-[35px] w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar">
            <h3 class="text-xl font-bold mb-6 text-slate-800 italic">Mes Param√®tres</h3>
            <div class="space-y-6">
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400 ml-2">Mon Allocation Mensuelle (‚Ç¨)</label>
                    <input type="number" id="settings-allocation" placeholder="0.00" class="w-full p-4 bg-gray-50 rounded-2xl border-none font-bold text-sm outline-none focus:ring-2 focus:ring-blue-500 mt-1">
                    <button onclick="updateAllocation()" class="w-full mt-2 bg-slate-100 text-slate-600 text-[10px] font-black py-2 rounded-xl uppercase hover:bg-slate-200">Mettre √† jour l'allocation</button>
                </div>
                <hr class="border-slate-100">
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400 ml-2">Mon IBAN</label>
                    <input type="text" id="settings-iban" placeholder="FR76..." class="w-full p-4 bg-gray-50 rounded-2xl border-none font-mono text-sm outline-none focus:ring-2 focus:ring-blue-500 mt-1">
                    <button onclick="updateIban()" class="w-full mt-2 bg-slate-100 text-slate-600 text-[10px] font-black py-2 rounded-xl uppercase hover:bg-slate-200">Mettre √† jour l'IBAN</button>
                </div>
                <hr class="border-slate-100">
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400 ml-2">Nouveau mot de passe</label>
                    <input type="password" id="settings-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-4 bg-gray-50 rounded-2xl border-none font-bold outline-none focus:ring-2 focus:ring-blue-500 mt-1">
                    <button onclick="updatePassword()" class="w-full mt-2 bg-blue-900 text-white text-[10px] font-black py-3 rounded-xl uppercase shadow-lg">Changer mon mot de passe</button>
                </div>
                <button onclick="closeSettingsModal()" class="w-full text-center text-[10px] font-bold text-gray-400 uppercase mt-4">Fermer</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://xccnnckuphxloxfrqtkf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjY25uY2t1cGh4bG94ZnJxdGtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODA3NjEsImV4cCI6MjA4Mjc1Njc2MX0.1mIEhKfS5OSsaw78f1_Iatni39y8CoIurAd5IXP6n6g";
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let userProfile = null;
        let currentType = 'depense';

        async function checkAuth() {
            const { data: { user } } = await sb.auth.getUser();
            if (!user) { window.location.href = "index.html"; return; }
            const { data: profile } = await sb.from('profiles').select('*, maisons(*)').eq('id', user.id).single();
            if (!profile || profile.role !== 'chef') { window.location.href = "user.html"; return; }
            userProfile = profile;
            document.getElementById('user-name').innerText = `${profile.prenom} ${profile.nom}`;
            document.getElementById('maison-name').innerText = `Maison ${profile.maisons.nom}`;
            
            // Initialisation de la date du jour
            document.getElementById('tx-date').valueAsDate = new Date();

            loadMotifs();
            refreshAll();
        }

        async function refreshAll() {
            refreshSoldes();
            loadAvancesChef();
            loadMembres();
            loadAuditGlobal();
        }

        async function refreshSoldes() {
            const { data: soldes } = await sb.from('soldes_calculables').select('*').eq('maison_id', userProfile.maison_id);
            let totalMaison = 0; let monPerso = 0;
            const today = new Date();

            if(soldes) {
                soldes.forEach(s => {
                    const solde = parseFloat(s.total_allocations) + parseFloat(s.total_transactions);
                    totalMaison += solde;
                    if(s.user_id === userProfile.id) monPerso = solde;
                });
            }
            document.getElementById('solde-maison').innerText = totalMaison.toFixed(2) + " ‚Ç¨";
            document.getElementById('solde-perso').innerText = monPerso.toFixed(2) + " ‚Ç¨";
        }

        async function loadAuditGlobal() {
            const { data } = await sb.from('transactions').select('*, profiles(prenom)').eq('maison_id', userProfile.maison_id).order('created_at', { ascending: false }).limit(20);
            document.getElementById('audit-history').innerHTML = data.map(t => `
                <div class="p-4 border-b border-gray-50 flex justify-between items-center text-xs">
                    <div class="flex items-center gap-3">
                        <button onclick="supprimerOperation('${t.id}')" class="text-red-300 hover:text-red-500 text-lg">√ó</button>
                        <div>
                            <p class="font-black uppercase text-[8px] text-gray-400">${t.profiles.prenom} ‚Ä¢ ${t.motif || 'RECETTE'}</p>
                            <p class="text-[7px] text-gray-300 font-bold mb-1">${new Date(t.created_at).toLocaleDateString('fr-FR')}</p>
                            <p class="font-bold text-slate-700">${t.commentaire || '-'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-black ${t.type === 'recette' ? 'text-emerald-500' : 'text-slate-900'}">${t.type === 'recette' ? '+' : '-'}${t.montant.toFixed(2)}‚Ç¨</p>
                        <p class="text-[7px] uppercase font-bold text-gray-300">${t.statut === 'attente' ? '‚è≥ Attente' : '‚úÖ Valid√©'}</p>
                    </div>
                </div>
            `).join('');
        }

        async function supprimerOperation(id) {
            if(!confirm("Supprimer cette op√©ration d√©finitivement ?")) return;
            await sb.from('transactions').delete().eq('id', id);
            refreshAll();
        }

        async function exportMaisonExcel() {
            const moisInput = prompt("Entrez le mois (format MM, ex: 01) :");
            if(!moisInput) return;
            const { data: txData } = await sb.from('transactions').select('created_at, type, montant, motif, commentaire, methode_paiement, profiles(prenom, nom)').eq('maison_id', userProfile.maison_id);
            const { data: membersData } = await sb.from('profiles').select('prenom, nom, allocation_mensuelle').eq('maison_id', userProfile.maison_id);
            const filteredTx = txData.filter(t => t.created_at.includes(`-${moisInput.padStart(2, '0')}-`));
            let finalRows = [];
            membersData.forEach(m => {
                if(m.allocation_mensuelle > 0) {
                    finalRows.push({ "Date": `01/${moisInput}/${new Date().getFullYear()}`, "Membre": `${m.prenom} ${m.nom}`, "Type": "ALLOCATION", "Motif": "VERSEMENT MENSUEL", "Montant (‚Ç¨)": m.allocation_mensuelle, "M√©thode": "AUTOMATIQUE", "Note": "Allocation mensuelle" });
                }
            });
            filteredTx.forEach(t => {
                finalRows.push({ "Date": new Date(t.created_at).toLocaleDateString(), "Membre": `${t.profiles.prenom} ${t.profiles.nom}`, "Type": t.type.toUpperCase(), "Motif": t.motif || "RECETTE", "Montant (‚Ç¨)": t.montant, "M√©thode": t.methode_paiement || "N/A", "Note": t.commentaire || "" });
            });
            const ws = XLSX.utils.json_to_sheet(finalRows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Comptabilit√©");
            ws['!cols'] = [{wch:12}, {wch:25}, {wch:15}, {wch:20}, {wch:12}, {wch:15}, {wch:30}];
            XLSX.writeFile(wb, `SMMD_Maison_${userProfile.maisons.nom}_Mois_${moisInput}.xlsx`);
        }

        async function loadAvancesChef() {
            const { data } = await sb.from('transactions').select('*, profiles(*)').eq('maison_id', userProfile.maison_id).eq('statut', 'attente');
            let dettesSum = 0; const groups = {};
            if(data) {
                data.forEach(t => {
                    dettesSum += t.montant;
                    if(!groups[t.user_id]) groups[t.user_id] = { name: `${t.profiles.prenom} ${t.profiles.nom}`, iban: t.profiles.iban, txs: [] };
                    groups[t.user_id].txs.push(t);
                });
            }
            document.getElementById('total-dettes').innerText = `Dettes : ${dettesSum.toFixed(2)}‚Ç¨`;
            document.getElementById('list-avances-attente').innerHTML = Object.keys(groups).map(uid => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-orange-200">
                    <div class="flex justify-between items-start mb-2"><p class="font-black text-[10px] text-orange-600 uppercase">${groups[uid].name}</p><button onclick="validerTout('${uid}')" class="bg-orange-600 text-white px-2 py-1 rounded-lg text-[8px] font-black">VALIDER LE VIREMENT</button></div>
                    <div class="flex items-center gap-2 mb-3"><p class="text-[8px] font-mono text-gray-500 truncate bg-gray-50 p-1 rounded flex-1">${groups[uid].iban || 'IBAN MANQUANT'}</p><button onclick="copyIban('${groups[uid].iban}')" class="text-[8px] font-bold text-blue-600 uppercase">Copier</button></div>
                    ${groups[uid].txs.map(t => `<div class="flex justify-between text-[10px] py-1 border-t border-gray-50"><span>${t.motif}</span><span class="font-bold">${t.montant.toFixed(2)}‚Ç¨</span></div>`).join('')}
                </div>
            `).join('');
        }

        async function loadMembres() {
            const { data } = await sb.from('profiles').select('*').eq('maison_id', userProfile.maison_id);
            document.getElementById('list-membres').innerHTML = data.map(m => `
                <div class="bg-white p-4 rounded-2xl flex justify-between items-start shadow-sm">
                    <div class="flex-1">
                        <p class="font-black text-xs uppercase">${m.prenom} ${m.nom} ${m.role === 'chef' ? 'üëë' : ''}</p>
                        <p class="text-[9px] text-gray-400 font-bold uppercase mb-2">Allocation : ${m.allocation_mensuelle || 0}‚Ç¨/mois</p>
                        <div class="bg-gray-50 p-2 rounded-lg flex items-center justify-between gap-2">
                             <p class="text-[8px] font-mono text-gray-500 truncate">${m.iban || 'IBAN NON RENSEIGN√â'}</p>
                             ${m.iban ? `<button onclick="copyIban('${m.iban}')" class="text-[8px] font-black text-blue-600 uppercase">Copier</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function submitTransaction() {
            const amount = parseFloat(document.getElementById('tx-amount').value);
            const date = document.getElementById('tx-date').value;
            const note = document.getElementById('tx-note').value.trim();
            const motif = document.getElementById('tx-motif').value;
            const method = document.getElementById('tx-method').value;

            if(!amount) return alert("Saisissez un montant");
            if(!date) return alert("Saisissez une date");

            const { error } = await sb.from('transactions').insert([{ 
                user_id: userProfile.id, 
                maison_id: userProfile.maison_id, 
                montant: amount, 
                motif: currentType === 'recette' ? 'RECETTE' : motif, 
                commentaire: note, 
                created_at: new Date(date).toISOString(),
                type: currentType, 
                methode_paiement: currentType === 'recette' ? null : method, 
                statut: (currentType === 'depense' && method.startsWith('perso_')) ? 'attente' : 'valide' 
            }]);

            if(!error) {
                document.getElementById('tx-amount').value = ''; 
                document.getElementById('tx-note').value = ''; 
                refreshAll();
            } else {
                alert("Erreur lors de l'enregistrement");
            }
        }

        async function loadMotifs() {
            const { data } = await sb.from('motifs').select('nom').order('nom');
            document.getElementById('tx-motif').innerHTML = data.map(m => `<option value="${m.nom}">${m.nom.toUpperCase()}</option>`).join('');
        }

        function openSettingsModal() { 
            document.getElementById('settings-modal').classList.remove('hidden'); 
            document.getElementById('settings-iban').value = userProfile.iban || ''; 
            document.getElementById('settings-allocation').value = userProfile.allocation_mensuelle || 0;
        }

        function closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }

        async function updateAllocation() {
            const newVal = parseFloat(document.getElementById('settings-allocation').value);
            if(isNaN(newVal)) return;
            const { error } = await sb.from('profiles').update({ allocation_mensuelle: newVal }).eq('id', userProfile.id);
            if(!error) {
                userProfile.allocation_mensuelle = newVal;
                alert("Allocation mise √† jour !");
                refreshAll();
            }
        }

        async function updateIban() { const newIban = document.getElementById('settings-iban').value.trim(); await sb.from('profiles').update({ iban: newIban }).eq('id', userProfile.id); userProfile.iban = newIban; alert("IBAN mis √† jour !"); refreshAll(); }
        async function updatePassword() { const newPass = document.getElementById('settings-pass').value; if(newPass.length < 6) return alert("6 car. min"); await sb.auth.updateUser({ password: newPass }); alert("Mot de passe modifi√© !"); closeSettingsModal(); }
        
        function setTxType(type) { 
            currentType = type; 
            const isR = type === 'recette'; 
            document.getElementById('container-motif').classList.toggle('hidden', isR); 
            document.getElementById('container-paiement').classList.toggle('hidden', isR); 
            document.getElementById('tab-depense').className = isR ? "flex-1 py-3 rounded-xl font-black text-[10px] bg-gray-100 text-gray-400" : "flex-1 py-3 rounded-xl font-black text-[10px] bg-blue-900 text-white tab-active"; 
            document.getElementById('tab-recette').className = isR ? "flex-1 py-3 rounded-xl font-black text-[10px] bg-emerald-500 text-white" : "flex-1 py-3 rounded-xl font-black text-[10px] bg-gray-100 text-gray-400"; 
        }

        function copyIban(iban) { if(!iban) return; navigator.clipboard.writeText(iban); alert("IBAN copi√© !"); }
        async function validerTout(uid) { if(!confirm("Virement fait ?")) return; await sb.from('transactions').update({ statut: 'valide', date_validation: new Date() }).eq('user_id', uid).eq('statut', 'attente'); refreshAll(); }
        function logout() { sb.auth.signOut().then(() => location.href="index.html"); }
        checkAuth();
    </script>
</body>
</html>
