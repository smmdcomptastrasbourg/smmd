<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMMD - Master Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans pb-20">

    <nav class="bg-white border-b p-6 flex justify-between items-center sticky top-0 z-50">
        <h1 class="text-2xl font-black italic tracking-tighter text-blue-900">SMMD. <span class="text-xs opacity-30 not-italic font-bold uppercase tracking-widest ml-2">Console Master</span></h1>
        <button onclick="logout()" class="bg-red-50 text-red-600 px-4 py-2 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-red-100 transition-all">Déconnexion</button>
    </nav>

    <main class="p-6 max-w-6xl mx-auto space-y-10">
        
        <section class="bg-white p-8 rounded-[40px] shadow-sm border border-gray-100">
            <h2 class="text-xs font-black uppercase tracking-widest text-blue-900 mb-6 flex items-center gap-2">
                <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span> Extraction des Données
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <select id="export-maison" class="p-4 bg-gray-50 rounded-2xl border-none font-bold outline-none text-sm"></select>
                <select id="export-month" class="p-4 bg-gray-50 rounded-2xl border-none font-bold outline-none text-sm">
                    <option value="01">Janvier</option><option value="02">Février</option><option value="03">Mars</option>
                    <option value="04">Avril</option><option value="05">Mai</option><option value="06">Juin</option>
                    <option value="07">Juillet</option><option value="08">Août</option><option value="09">Septembre</option>
                    <option value="10">Octobre</option><option value="11">Novembre</option><option value="12">Décembre</option>
                </select>
                <button onclick="exportData()" class="bg-blue-900 text-white font-black py-4 rounded-2xl uppercase text-[10px] tracking-widest shadow-lg shadow-blue-900/20 hover:scale-[1.02] transition-all">Télécharger CSV</button>
            </div>
        </section>

        <section class="bg-white p-8 rounded-[40px] shadow-sm border border-gray-100">
            <h2 class="text-xs font-black uppercase tracking-widest text-gray-400 mb-6">Gestion des Maisons</h2>
            <div class="flex gap-2 mb-8">
                <input type="text" id="new-maison-name" placeholder="Nom de la maison..." class="flex-1 p-4 bg-gray-50 rounded-2xl border-none font-bold outline-none text-sm">
                <button onclick="addMaison()" class="bg-slate-900 text-white px-8 rounded-2xl font-black text-[10px] uppercase">Ajouter</button>
            </div>
            <div id="maisons-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </section>

        <section class="bg-white p-8 rounded-[40px] shadow-sm border border-gray-100">
            <h2 class="text-xs font-black uppercase tracking-widest text-gray-400 mb-6">Nouveau Membre</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <input type="email" id="user-email" placeholder="Email" class="p-4 bg-gray-50 rounded-2xl border-none font-bold text-sm outline-none">
                <input type="password" id="user-pass" placeholder="Password" class="p-4 bg-gray-50 rounded-2xl border-none font-bold text-sm outline-none">
                <input type="text" id="user-prenom" placeholder="Prénom" class="p-4 bg-gray-50 rounded-2xl border-none font-bold text-sm outline-none">
                <input type="text" id="user-nom" placeholder="Nom" class="p-4 bg-gray-50 rounded-2xl border-none font-bold text-sm outline-none">
                <select id="user-maison" class="p-4 bg-gray-50 rounded-2xl border-none font-bold text-sm outline-none"></select>
                <select id="user-role" class="p-4 bg-gray-50 rounded-2xl border-none font-bold text-sm outline-none">
                    <option value="user">Utilisateur</option>
                    <option value="chef">Chef de Maison</option>
                </select>
                <button onclick="registerUser()" class="lg:col-span-2 bg-blue-600 text-white font-black py-4 rounded-2xl uppercase text-[10px] tracking-widest shadow-lg">Créer le compte</button>
            </div>
            <div id="users-list" class="space-y-2"></div>
        </section>

        <section class="bg-white p-8 rounded-[40px] shadow-sm border border-gray-100">
            <h2 class="text-xs font-black uppercase tracking-widest text-gray-400 mb-6">Motifs de dépense</h2>
            <div class="flex gap-2 mb-6">
                <input type="text" id="new-motif" placeholder="Nouveau motif..." class="flex-1 p-4 bg-gray-50 rounded-2xl border-none font-bold outline-none text-sm">
                <button onclick="addMotif()" class="bg-slate-900 text-white px-8 rounded-2xl font-black text-[10px] uppercase">OK</button>
            </div>
            <div id="motifs-list" class="flex flex-wrap gap-2"></div>
        </section>

    </main>

    <script>
        const SUPABASE_URL = "https://xccnnckuphxloxfrqtkf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjY25uY2t1cGh4bG94ZnJxdGtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODA3NjEsImV4cCI6MjA4Mjc1Njc2MX0.1mIEhKfS5OSsaw78f1_Iatni39y8CoIurAd5IXP6n6g";
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function init() {
            loadMaisons();
            loadUsers();
            loadMotifs();
        }

        // --- EXPORT (CORRIGÉ) ---
        async function exportData() {
            const month = document.getElementById('export-month').value;
            const maisonId = document.getElementById('export-maison').value;
            const year = new Date().getFullYear();

            // 1. Récupération des transactions
            let txQuery = sb.from('transactions')
                          .select('created_at, type, montant, motif, commentaire, methode_paiement, profiles(prenom, nom), maisons(nom)')
                          .order('created_at', { ascending: true });

            if (maisonId !== 'all') {
                txQuery = txQuery.eq('maison_id', maisonId);
            }

            const { data: transactions, error: txError } = await txQuery;
            if (txError) return alert("Erreur transactions : " + txError.message);

            // 2. Récupération des membres pour inclure leurs allocations
            let membersQuery = sb.from('profiles').select('prenom, nom, allocation_mensuelle, maison_id, maisons(nom)');
            if (maisonId !== 'all') {
                membersQuery = membersQuery.eq('maison_id', maisonId);
            }
            const { data: members, error: memError } = await membersQuery;
            if (memError) return alert("Erreur membres : " + memError.message);

            // Filtrage des transactions par mois
            const filteredTx = transactions.filter(t => t.created_at.includes(`-${month}-`));

            // Construction du CSV avec BOM pour Excel
            let csvContent = "\uFEFF"; 
            csvContent += "Date;Maison;Membre;Type;Motif;Montant;Méthode;Commentaire\n";

            // AJOUT DES ALLOCATIONS (Lignes théoriques au 1er du mois)
            members.forEach(m => {
                if (m.allocation_mensuelle > 0) {
                    const montantAlloc = m.allocation_mensuelle.toString().replace('.', ',');
                    const nomMaison = m.maisons ? m.maisons.nom : 'N/A';
                    csvContent += `01/${month}/${year};${nomMaison};${m.prenom} ${m.nom};REVENU;ALLOCATION MENSUELLE;${montantAlloc};AUTOMATIQUE;Génération auto\n`;
                }
            });

            // AJOUT DES TRANSACTIONS RÉELLES
            filteredTx.forEach(t => {
                const date = new Date(t.created_at).toLocaleDateString('fr-FR');
                const maison = t.maisons ? t.maisons.nom : 'N/A';
                const membre = t.profiles ? `${t.profiles.prenom} ${t.profiles.nom}` : 'Inconnu';
                const type = t.type.toUpperCase();
                const motif = t.motif || (t.type === 'recette' ? 'RECETTE' : 'N/A');
                const montant = t.montant.toString().replace('.', ',');
                const methode = t.methode_paiement || '-';
                const note = (t.commentaire || '').replace(/;/g, ',');

                csvContent += `${date};${maison};${membre};${type};${motif};${montant};${methode};${note}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `SMMD_Compta_Maison_${maisonId}_Mois_${month}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- AUTRES FONCTIONS (INCHANGÉES) ---
        async function loadMaisons() {
            const { data } = await sb.from('maisons').select('*').order('nom');
            const list = document.getElementById('maisons-list');
            const selectExport = document.getElementById('export-maison');
            const selectUser = document.getElementById('user-maison');

            const options = data.map(m => `<option value="${m.id}">${m.nom}</option>`).join('');
            selectExport.innerHTML = `<option value="all">Toutes les maisons</option>` + options;
            selectUser.innerHTML = options;

            list.innerHTML = data.map(m => `
                <div class="bg-gray-50 p-6 rounded-[30px] flex justify-between items-center group hover:bg-blue-50 transition-all">
                    <span class="font-black text-sm uppercase tracking-tight">${m.nom}</span>
                    <button onclick="deleteMaison('${m.id}')" class="opacity-0 group-hover:opacity-100 text-red-400 text-xs font-bold uppercase tracking-widest">Supprimer</button>
                </div>
            `).join('');
        }

        async function addMaison() {
            const name = document.getElementById('new-maison-name').value.trim();
            if(!name) return;
            await sb.from('maisons').insert([{ nom: name }]);
            document.getElementById('new-maison-name').value = '';
            loadMaisons();
        }

        async function deleteMaison(id) {
            if(!confirm("Supprimer cette maison ?")) return;
            await sb.from('maisons').delete().eq('id', id);
            loadMaisons();
        }

        async function loadUsers() {
            const { data } = await sb.from('profiles').select('*, maisons(nom)').order('prenom');
            document.getElementById('users-list').innerHTML = data.map(u => `
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-2xl hover:bg-white border border-transparent hover:border-gray-100 transition-all">
                    <div class="flex gap-4 items-center">
                        <span class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-[10px] font-black">${u.prenom[0]}${u.nom[0]}</span>
                        <div>
                            <p class="text-xs font-black uppercase">${u.prenom} ${u.nom} <span class="text-[8px] text-gray-400 ml-2">${u.role}</span></p>
                            <p class="text-[9px] font-bold text-blue-500 uppercase">${u.maisons ? u.maisons.nom : 'Sans Maison'}</p>
                        </div>
                    </div>
                    <button onclick="deleteUser('${u.id}')" class="text-[9px] font-black text-red-300 hover:text-red-500 uppercase">Supprimer</button>
                </div>
            `).join('');
        }

        async function registerUser() {
            const email = document.getElementById('user-email').value;
            const pass = document.getElementById('user-pass').value;
            const prenom = document.getElementById('user-prenom').value;
            const nom = document.getElementById('user-nom').value;
            const maison = document.getElementById('user-maison').value;
            const role = document.getElementById('user-role').value;

            const { data, error } = await sb.auth.signUp({ email, password: pass });
            if(error) return alert(error.message);

            await sb.from('profiles').insert([{
                id: data.user.id, prenom, nom, maison_id: maison, role: role
            }]);

            alert("Utilisateur créé !");
            loadUsers();
        }

        async function deleteUser(id) {
            if(!confirm("Supprimer l'utilisateur ?")) return;
            await sb.from('profiles').delete().eq('id', id);
            loadUsers();
        }

        async function loadMotifs() {
            const { data } = await sb.from('motifs').select('*').order('nom');
            document.getElementById('motifs-list').innerHTML = data.map(m => `
                <div class="bg-gray-100 px-4 py-2 rounded-full flex items-center gap-3">
                    <span class="text-[10px] font-black uppercase text-gray-500">${m.nom}</span>
                    <button onclick="deleteMotif('${m.id}')" class="text-gray-300 hover:text-red-500 font-bold">×</button>
                </div>
            `).join('');
        }

        async function addMotif() {
            const nom = document.getElementById('new-motif').value.trim();
            if(!nom) return;
            await sb.from('motifs').insert([{ nom }]);
            document.getElementById('new-motif').value = '';
            loadMotifs();
        }

        async function deleteMotif(id) {
            await sb.from('motifs').delete().eq('id', id);
            loadMotifs();
        }

        function logout() { sb.auth.signOut().then(() => location.href = 'index.html'); }

        init();
    </script>
</body>
</html>

