<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMMD - Espace Membre</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .active-tab { background-color: #1e3a8a !important; color: white !important; }
        .active-recette { background-color: #10b981 !important; color: white !important; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-10">

    <nav class="bg-blue-900 text-white p-6 rounded-b-[40px] shadow-lg sticky top-0 z-50">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h1 id="user-name" class="text-xl font-black italic tracking-tighter">Chargement...</h1>
                <p id="maison-name" class="text-[10px] uppercase tracking-[0.2em] opacity-60 font-bold italic">Maison ...</p>
            </div>
            <button onclick="logout()" class="bg-white/10 p-3 rounded-2xl">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
            </button>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white/10 p-4 rounded-3xl backdrop-blur-md">
                <p class="text-[9px] uppercase font-black opacity-60 mb-1">Mon Solde</p>
                <h2 id="balance" class="text-2xl font-black">0.00‚Ç¨</h2>
            </div>
            <div class="bg-orange-500/20 p-4 rounded-3xl backdrop-blur-md">
                <p class="text-[9px] uppercase font-black text-orange-200 mb-1">√Ä me rembourser</p>
                <h2 id="pending-refund" class="text-2xl font-black text-orange-100">0.00‚Ç¨</h2>
            </div>
        </div>
    </nav>

    <main class="p-6 space-y-8">
        
        <section class="bg-white p-6 rounded-[35px] shadow-sm border border-gray-100">
            <div class="flex bg-gray-100 p-1.5 rounded-2xl mb-6">
                <button id="tab-depense" onclick="setTxType('depense')" class="flex-1 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest active-tab">D√©pense</button>
                <button id="tab-recette" onclick="setTxType('recette')" class="flex-1 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest">Recette</button>
            </div>

            <div class="space-y-4">
                <div class="relative">
                    <input type="number" id="tx-amount" placeholder="0.00" class="w-full bg-gray-50 p-6 rounded-3xl text-3xl font-black text-center outline-none border-2 border-transparent focus:border-blue-900 transition-all">
                    <span class="absolute right-6 top-1/2 -translate-y-1/2 font-black text-gray-300">‚Ç¨</span>
                </div>

                <div id="container-motif">
                    <label class="text-[10px] font-black uppercase text-gray-400 ml-2">Motif de la d√©pense</label>
                    <select id="tx-motif" class="w-full bg-gray-50 p-4 rounded-2xl font-bold mt-1 outline-none appearance-none"></select>
                </div>

                <div id="container-paiement">
                    <label class="text-[10px] font-black uppercase text-gray-400 ml-2">Moyen de paiement</label>
                    <select id="tx-method" class="w-full bg-gray-50 p-4 rounded-2xl font-bold mt-1 outline-none appearance-none">
                        <option value="maison_cb">CB MAISON</option>
                        <option value="perso_cb">MA CARTE PERSO (√Ä REMBOURSER)</option>
                        <option value="perso_especes">MES ESP√àCES (√Ä REMBOURSER)</option>
                    </select>
                </div>

                <input type="text" id="tx-note" placeholder="Commentaire libre..." class="w-full bg-gray-50 p-4 rounded-2xl font-bold outline-none border-none">

                <div class="grid grid-cols-4 gap-2">
                    <button onclick="document.getElementById('tx-file').click()" class="aspect-square bg-gray-100 rounded-2xl flex flex-col items-center justify-center text-gray-400 hover:bg-blue-50 hover:text-blue-600 transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <span class="text-[8px] font-black mt-1 uppercase">Re√ßu</span>
                    </button>
                    <input type="file" id="tx-file" accept="image/*" capture="environment" class="hidden">
                    <button onclick="submitTx()" class="col-span-3 bg-blue-900 text-white rounded-2xl font-black text-[11px] uppercase tracking-[0.2em] shadow-lg shadow-blue-900/30">Valider la saisie</button>
                </div>
            </div>
        </section>

        <section>
            <div class="flex justify-between items-center mb-4 px-2">
                <h3 class="text-[10px] font-black uppercase tracking-widest text-gray-400 italic">Derni√®res op√©rations</h3>
                <button onclick="undoLast()" class="text-[9px] font-black text-red-500 uppercase">Annuler la derni√®re</button>
            </div>
            <div id="tx-history" class="space-y-3"></div>
        </section>

        <section class="bg-slate-900 p-8 rounded-[40px] text-white space-y-6 shadow-xl">
            <h3 class="text-xs font-black uppercase tracking-widest opacity-50 italic">Param√®tres du compte</h3>
            
            <div>
                <label class="text-[9px] font-black uppercase opacity-40 ml-1">Mon IBAN (pour remboursements)</label>
                <div class="flex gap-2 mt-1">
                    <input type="text" id="user-iban" class="flex-1 bg-white/10 p-4 rounded-2xl font-mono text-xs border-none outline-none focus:bg-white/20" placeholder="FR76...">
                    <button onclick="updateIban()" class="bg-blue-600 px-4 rounded-2xl font-black text-[10px] uppercase">OK</button>
                </div>
            </div>

            <div class="pt-4 border-t border-white/10">
                <label class="text-[9px] font-black uppercase opacity-40 ml-1">Changer mon mot de passe</label>
                <div class="flex gap-2 mt-1">
                    <input type="password" id="new-password" class="flex-1 bg-white/10 p-4 rounded-2xl font-bold text-xs border-none outline-none focus:bg-white/20" placeholder="Nouveau mot de passe">
                    <button onclick="updatePassword()" class="bg-emerald-600 px-4 rounded-2xl font-black text-[10px] uppercase">Modifier</button>
                </div>
            </div>
        </section>

    </main>

    <script>
        const SUPABASE_URL = "https://xccnnckuphxloxfrqtkf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjY25uY2t1cGh4bG94ZnJxdGtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODA3NjEsImV4cCI6MjA4Mjc1Njc2MX0.1mIEhKfS5OSsaw78f1_Iatni39y8CoIurAd5IXP6n6g";
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let userProfile = null;
        let currentType = 'depense';

        async function init() {
            const { data: { user } } = await sb.auth.getUser();
            if (!user) { window.location.href = "index.html"; return; }

            const { data: profile } = await sb.from('profiles').select('*, maisons(nom)').eq('id', user.id).single();
            userProfile = profile;

            document.getElementById('user-name').innerText = `${profile.prenom} ${profile.nom}`;
            document.getElementById('maison-name').innerText = `Maison ${profile.maisons.nom}`;
            document.getElementById('user-iban').value = profile.iban || '';

            loadMotifs();
            refreshDashboard();
        }

        async function loadMotifs() {
            const { data } = await sb.from('motifs').select('*').order('nom');
            document.getElementById('tx-motif').innerHTML = data.map(m => `<option value="${m.nom}">${m.nom.toUpperCase()}</option>`).join('');
        }

        async function refreshDashboard() {
            // Solde = Allocations cumul√©es + Recettes - D√©penses
            const { data: txs } = await sb.from('transactions').select('*').eq('user_id', userProfile.id);
            const totalRecettes = txs.filter(t => t.type === 'recette').reduce((sum, t) => sum + t.montant, 0);
            const totalDepenses = txs.filter(t => t.type === 'depense').reduce((sum, t) => sum + t.montant, 0);
            
            // On calcule le nombre de mois depuis l'inscription pour les allocations
            const months = Math.max(1, new Date().getMonth() - new Date(userProfile.created_at).getMonth() + 1);
            const solde = (userProfile.allocation_mensuelle * months) + totalRecettes - totalDepenses;
            
            // √Ä rembourser (D√©penses perso en attente)
            const aRembourser = txs.filter(t => t.statut === 'attente').reduce((sum, t) => sum + t.montant, 0);

            document.getElementById('balance').innerText = `${solde.toFixed(2)}‚Ç¨`;
            document.getElementById('pending-refund').innerText = `${aRembourser.toFixed(2)}‚Ç¨`;

            // Historique
            const { data: history } = await sb.from('transactions').select('*').eq('user_id', userProfile.id).order('created_at', { ascending: false }).limit(8);
            document.getElementById('tx-history').innerHTML = history.map(t => `
                <div class="flex justify-between items-center p-4 bg-white rounded-2xl shadow-sm border border-gray-50">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full ${t.type === 'recette' ? 'bg-emerald-500' : (t.statut === 'attente' ? 'bg-orange-500' : 'bg-blue-900')}"></div>
                        <div>
                            <p class="text-[10px] font-black uppercase tracking-tight">${t.motif || 'RECETTE'}</p>
                            <p class="text-[8px] text-gray-400 font-bold uppercase">${new Date(t.created_at).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 text-right">
                        ${t.photo_url ? `<button onclick="window.open('${sb.storage.from('receipts').getPublicUrl(t.photo_url).data.publicUrl}')" class="text-xs">üìÑ</button>` : ''}
                        <p class="font-black text-sm ${t.type === 'recette' ? 'text-emerald-600' : 'text-slate-900'}">${t.type === 'recette' ? '+' : '-'}${t.montant.toFixed(2)}‚Ç¨</p>
                    </div>
                </div>
            `).join('');
        }

        async function submitTx() {
            const amount = parseFloat(document.getElementById('tx-amount').value);
            const motif = document.getElementById('tx-motif').value;
            const method = document.getElementById('tx-method').value;
            const note = document.getElementById('tx-note').value;
            const file = document.getElementById('tx-file').files[0];

            if (!amount) return alert("Veuillez saisir un montant");

            let photoPath = null;
            if (file) {
                const fileName = `${Date.now()}_${userProfile.id}.jpg`;
                const { data, error } = await sb.storage.from('receipts').upload(fileName, file);
                if (!error) photoPath = fileName;
            }

            await sb.from('transactions').insert([{
                user_id: userProfile.id,
                maison_id: userProfile.maison_id,
                montant: amount,
                motif: currentType === 'recette' ? 'RECETTE' : motif,
                commentaire: note,
                type: currentType,
                methode_paiement: currentType === 'recette' ? null : method,
                statut: (currentType === 'depense' && method.startsWith('perso_')) ? 'attente' : 'valide',
                photo_url: photoPath
            }]);

            document.getElementById('tx-amount').value = '';
            document.getElementById('tx-note').value = '';
            document.getElementById('tx-file').value = '';
            alert("Saisie enregistr√©e !");
            refreshDashboard();
        }

        async function updateIban() {
            const iban = document.getElementById('user-iban').value;
            await sb.from('profiles').update({ iban }).eq('id', userProfile.id);
            alert("IBAN enregistr√©");
        }

        // --- NOUVELLE FONCTION : CHANGEMENT DE MOT DE PASSE ---
        async function updatePassword() {
            const newPass = document.getElementById('new-password').value;
            if (newPass.length < 6) return alert("Le mot de passe doit faire au moins 6 caract√®res.");

            const { error } = await sb.auth.updateUser({ password: newPass });
            
            if (error) {
                alert("Erreur : " + error.message);
            } else {
                alert("Mot de passe mis √† jour avec succ√®s !");
                document.getElementById('new-password').value = '';
            }
        }

        async function undoLast() {
            const { data } = await sb.from('transactions').select('id').eq('user_id', userProfile.id).order('created_at', { ascending: false }).limit(1);
            if (data && data[0] && confirm("Annuler la derni√®re op√©ration ?")) {
                await sb.from('transactions').delete().eq('id', data[0].id);
                refreshDashboard();
            }
        }

        function setTxType(type) {
            currentType = type;
            const isR = type === 'recette';
            document.getElementById('container-motif').classList.toggle('hidden', isR);
            document.getElementById('container-paiement').classList.toggle('hidden', isR);
            document.getElementById('tab-depense').className = isR ? "flex-1 py-3 rounded-xl font-black text-[10px] bg-gray-100 text-gray-400" : "flex-1 py-3 rounded-xl font-black text-[10px] bg-blue-900 text-white active-tab";
            document.getElementById('tab-recette').className = isR ? "flex-1 py-3 rounded-xl font-black text-[10px] bg-emerald-500 text-white active-recette" : "flex-1 py-3 rounded-xl font-black text-[10px] bg-gray-100 text-gray-400";
        }

        function logout() { sb.auth.signOut().then(() => window.location.href = "index.html"); }

        init();
    </script>
</body>
</html>
