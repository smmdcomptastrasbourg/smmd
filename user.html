<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMMD - Espace Membre</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-10">

    <nav class="bg-blue-900 text-white p-6 rounded-b-[40px] shadow-lg sticky top-0 z-50">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h1 id="user-name" class="text-xl font-black italic">Chargement...</h1>
                <p id="maison-name" class="text-[10px] uppercase tracking-[0.2em] opacity-60 font-bold">Maison ...</p>
            </div>
            <button onclick="logout()" class="bg-blue-800 p-2 rounded-xl text-[10px] font-bold uppercase tracking-widest">Sortir</button>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-blue-800/50 p-4 rounded-2xl border border-blue-700/50">
                <p class="text-[8px] font-black uppercase tracking-widest mb-1 opacity-60">Mon Solde Perso</p>
                <p id="solde-perso" class="text-xl font-black">-- €</p>
            </div>
            <div class="bg-white/10 p-4 rounded-2xl border border-white/10">
                <p class="text-[8px] font-black uppercase tracking-widest mb-1 opacity-60">Solde Maison</p>
                <p id="solde-maison" class="text-xl font-black">-- €</p>
            </div>
        </div>
    </nav>

    <main class="p-6 space-y-6">

        <section class="bg-white p-6 rounded-[35px] shadow-sm border border-gray-100">
            <div class="flex gap-4 mb-6">
                <button onclick="setTxType('depense')" id="tab-depense" class="flex-1 py-2 rounded-xl font-black text-[10px] uppercase tracking-widest bg-blue-900 text-white transition-all">Dépense</button>
                <button onclick="setTxType('recette')" id="tab-recette" class="flex-1 py-2 rounded-xl font-black text-[10px] uppercase tracking-widest bg-gray-100 text-gray-400 transition-all">Recette</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-[9px] font-black uppercase ml-2 text-gray-400">Montant (€)</label>
                    <input type="number" id="tx-amount" step="0.01" placeholder="0.00" class="w-full p-4 bg-gray-50 rounded-2xl border-none font-black text-xl outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div id="container-motif">
                    <label class="text-[9px] font-black uppercase ml-2 text-gray-400">Motif</label>
                    <select id="tx-motif" class="w-full p-4 bg-gray-50 rounded-2xl border-none font-bold outline-none focus:ring-2 focus:ring-blue-500"></select>
                </div>

                <div id="container-paiement">
                    <label class="text-[9px] font-black uppercase ml-2 text-gray-400">Moyen de paiement</label>
                    <select id="tx-method" onchange="toggleAvanceInfo()" class="w-full p-4 bg-gray-50 rounded-2xl border-none font-bold outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="cb_maison">CB MAISON</option>
                        <option value="perso_cb">PERSO - CB</option>
                        <option value="perso_liquide">PERSO - Liquide</option>
                        <option value="perso_cheque">PERSO - Chèque</option>
                        <option value="perso_virement">PERSO - Virement</option>
                    </select>
                    <p id="info-avance" class="hidden text-[9px] text-orange-500 font-bold uppercase mt-2 ml-2 italic">⚠️ Nécessite validation du chef</p>
                </div>

                <div>
                    <label class="text-[9px] font-black uppercase ml-2 text-gray-400">Commentaire (Optionnel)</label>
                    <input type="text" id="tx-note" placeholder="ex: Courses Leclerc..." class="w-full p-4 bg-gray-50 rounded-2xl border-none font-bold outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                </div>

                <button onclick="submitTransaction()" id="btn-submit" class="w-full bg-blue-900 text-white font-black py-5 rounded-2xl uppercase tracking-widest shadow-lg active:scale-95 transition-all">Enregistrer</button>
            </div>
        </section>

        <section id="chef-section" class="hidden bg-orange-50 p-6 rounded-[35px] border border-orange-100">
            <h2 class="text-[10px] font-black uppercase tracking-widest text-orange-600 mb-4 flex justify-between">
                Validation Avances
                <span id="badge-count" class="bg-orange-600 text-white px-2 py-0.5 rounded-full text-[8px]">0</span>
            </h2>
            <div id="list-avances-attente" class="space-y-3">
                </div>
        </section>

        <section class="space-y-4">
            <div class="flex justify-between items-center px-2">
                <h2 class="text-[10px] font-black uppercase tracking-widest text-gray-400">Mon Historique</h2>
                <button onclick="undoLast()" class="text-[9px] font-bold uppercase text-red-500 hover:underline">Annuler dernier</button>
            </div>
            <div id="user-history" class="space-y-3">
                </div>
        </section>

    </main>

    <script>
        const SUPABASE_URL = "https://xccnnckuphxloxfrqtkf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjY25uY2t1cGh4bG94ZnJxdGtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODA3NjEsImV4cCI6MjA4Mjc1Njc2MX0.1mIEhKfS5OSsaw78f1_Iatni39y8CoIurAd5IXP6n6g";
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let userProfile = null;
        let currentType = 'depense';

        async function checkAuth() {
            const { data: { user } } = await sb.auth.getUser();
            if (!user) { window.location.href = "index.html"; return; }
            
            const { data: profile, error } = await sb.from('profiles').select('*, maisons(nom, id)').eq('id', user.id).single();
            
            if (error || !profile.maison_id) {
                alert("Erreur profil ou maison non configurée.");
                window.location.href = "index.html";
                return;
            }

            userProfile = profile;
            document.getElementById('user-name').innerText = `${profile.prenom} ${profile.nom}`;
            document.getElementById('maison-name').innerText = `Maison ${profile.maisons.nom}`;
            
            if (profile.role === 'chef') {
                document.getElementById('chef-section').classList.remove('hidden');
                loadAvancesChef();
            }

            loadMotifs();
            refreshDashboard();
        }

        async function loadMotifs() {
            const { data } = await sb.from('motifs').select('nom').order('nom');
            document.getElementById('tx-motif').innerHTML = data.map(m => `<option value="${m.nom}">${m.nom}</option>`).join('');
        }

        function setTxType(type) {
            currentType = type;
            const btnD = document.getElementById('tab-depense');
            const btnR = document.getElementById('tab-recette');
            const pnlPaiement = document.getElementById('container-paiement');

            if (type === 'recette') {
                btnR.className = "flex-1 py-2 rounded-xl font-black text-[10px] uppercase tracking-widest bg-emerald-500 text-white";
                btnD.className = "flex-1 py-2 rounded-xl font-black text-[10px] uppercase tracking-widest bg-gray-100 text-gray-400";
                pnlPaiement.classList.add('hidden');
            } else {
                btnD.className = "flex-1 py-2 rounded-xl font-black text-[10px] uppercase tracking-widest bg-blue-900 text-white";
                btnR.className = "flex-1 py-2 rounded-xl font-black text-[10px] uppercase tracking-widest bg-gray-100 text-gray-400";
                pnlPaiement.classList.remove('hidden');
            }
        }

        function toggleAvanceInfo() {
            const method = document.getElementById('tx-method').value;
            const info = document.getElementById('info-avance');
            method.startsWith('perso_') ? info.classList.remove('hidden') : info.classList.add('hidden');
        }

        async function refreshDashboard() {
            // 1. Charger transactions maison
            const { data: txs } = await sb.from('transactions').select('*').eq('maison_id', userProfile.maison_id);
            
            // Calcul Solde Maison (Allocation cumulée - Dépenses validées ou CB Maison)
            // Note: Simplifié ici, l'idéal est une vue SQL pour la précision
            let totalMaison = userProfile.maisons.allocation_totale || 0; 
            let depensesMaison = 0;
            let soldePerso = userProfile.allocation || 0;

            txs.forEach(t => {
                const isValide = (t.statut === 'valide' || t.methode_paiement === 'cb_maison');
                if (t.type === 'depense' && isValide) depensesMaison += t.montant;
                if (t.type === 'recette') depensesMaison -= t.montant;

                // Calcul Perso
                if (t.user_id === userProfile.id) {
                    if (t.type === 'depense' && isValide) soldePerso -= t.montant;
                    if (t.type === 'recette') soldePerso += t.montant;
                }
            });

            document.getElementById('solde-maison').innerText = (totalMaison - depensesMaison).toFixed(2) + " €";
            document.getElementById('solde-perso').innerText = soldePerso.toFixed(2) + " €";

            // Historique
            const myTxs = txs.filter(t => t.user_id === userProfile.id).slice(0, 10);
            document.getElementById('user-history').innerHTML = myTxs.map(t => `
                <div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-gray-50">
                    <div>
                        <p class="text-[10px] font-black uppercase text-gray-400">${t.motif} ${t.statut === 'attente' ? '⏳' : ''}</p>
                        <p class="text-xs font-bold">${t.commentaire || 'Sans titre'}</p>
                    </div>
                    <p class="font-black ${t.type === 'recette' ? 'text-emerald-500' : 'text-slate-900'}">
                        ${t.type === 'recette' ? '+' : '-'}${t.montant.toFixed(2)}€
                    </p>
                </div>
            `).join('');
        }

        async function submitTransaction() {
            const amount = parseFloat(document.getElementById('tx-amount').value);
            const motif = document.getElementById('tx-motif').value;
            const note = document.getElementById('tx-note').value;
            const method = document.getElementById('tx-method').value;

            if (!amount || amount <= 0) return alert("Montant invalide");

            const isAvance = method.startsWith('perso_');
            
            const { error } = await sb.from('transactions').insert([{
                user_id: userProfile.id,
                maison_id: userProfile.maison_id,
                montant: amount,
                motif: currentType === 'recette' ? 'RECETTE' : motif,
                commentaire: note,
                type: currentType,
                methode_paiement: currentType === 'recette' ? null : method,
                statut: isAvance ? 'attente' : 'valide'
            }]);

            if (error) alert(error.message);
            else {
                document.getElementById('tx-amount').value = '';
                document.getElementById('tx-note').value = '';
                refreshDashboard();
            }
        }

        async function loadAvancesChef() {
            const { data } = await sb.from('transactions')
                .select('*, profiles(prenom, nom)')
                .eq('maison_id', userProfile.maison_id)
                .eq('statut', 'attente');

            document.getElementById('badge-count').innerText = data.length;
            document.getElementById('list-avances-attente').innerHTML = data.map(t => `
                <div class="bg-white/60 p-3 rounded-xl flex justify-between items-center border border-orange-200">
                    <div class="text-[10px]">
                        <span class="font-black uppercase">${t.profiles.prenom}</span> : <b>${t.montant}€</b><br>
                        <span class="opacity-50">${t.methode_paiement}</span>
                    </div>
                    <button onclick="validerAvance('${t.id}')" class="bg-orange-600 text-white px-3 py-1.5 rounded-lg font-black text-[8px] uppercase">Valider</button>
                </div>
            `).join('');
        }

        async function validerAvance(id) {
            await sb.from('transactions').update({ statut: 'valide', date_validation: new Date() }).eq('id', id);
            loadAvancesChef();
            refreshDashboard();
        }

        async function undoLast() {
            if (!confirm("Annuler votre dernière opération ?")) return;
            const { data } = await sb.from('transactions')
                .select('id')
                .eq('user_id', userProfile.id)
                .order('created_at', { ascending: false })
                .limit(1);

            if (data.length > 0) {
                await sb.from('transactions').delete().eq('id', data[0].id);
                refreshDashboard();
            }
        }

        function logout() { sb.auth.signOut().then(() => window.location.href = "index.html"); }

        checkAuth();
    </script>
</body>
</html>
